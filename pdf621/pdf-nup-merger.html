<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF N-Up Merger</title>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 500px;
            width: 100%;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
            font-size: 24px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .upload-area:hover, .upload-area.dragover {
            border-color: #764ba2;
            background: rgba(102, 126, 234, 0.05);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .upload-text {
            color: #555;
            font-size: 16px;
        }

        .upload-text strong {
            color: #667eea;
        }

        .file-input {
            display: none;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .page-count-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .page-count-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .file-list {
            margin-bottom: 20px;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f8f9fa;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .file-name {
            flex: 1;
            font-size: 14px;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-size {
            font-size: 12px;
            color: #888;
            margin-left: 10px;
        }

        .remove-btn {
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 6px;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 10px;
            transition: background 0.3s ease;
        }

        .remove-btn:hover {
            background: #e84118;
        }

        .ok-btn {
            width: 100%;
            padding: 14px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .ok-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .ok-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status {
            text-align: center;
            margin-top: 15px;
            font-size: 14px;
        }

        .status.success {
            color: #2ecc71;
        }

        .status.error {
            color: #e74c3c;
        }

        .status.info {
            color: #3498db;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            margin-top: 15px;
            overflow: hidden;
            display: none;
        }

        .progress-bar.active {
            display: block;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        .info-text {
            font-size: 12px;
            color: #888;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>PDF N-Up Merger</h1>
        <p class="subtitle">Merge PDF files with N-up tiling</p>

        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">ðŸ“„</div>
            <div class="upload-text">
                <strong>Click to upload</strong> or drag & drop PDF files
            </div>
            <input type="file" id="fileInput" class="file-input" accept=".pdf" multiple>
        </div>

        <div class="file-list" id="fileList"></div>

        <div class="control-group">
            <label class="control-label" for="pageCount">Pages per sheet (N-up):</label>
            <input type="number" id="pageCount" class="page-count-input" value="6" min="1" max="16">
        </div>

        <button class="ok-btn" id="okBtn" disabled>Process PDFs</button>

        <div class="progress-bar" id="progressBar">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <div class="status" id="status"></div>

        <div class="info-text">
            <strong>How it works:</strong> Upload multiple PDF files, specify how many pages (x)
            should be combined onto a single sheet, and the app will create a merged PDF with N-up layout.
            Default is 6 pages per sheet (2x3 grid).
        </div>
    </div>

    <script>
        const { PDFDocument, rgb, degrees } = PDFLib;

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const pageCountInput = document.getElementById('pageCount');
        const okBtn = document.getElementById('okBtn');
        const status = document.getElementById('status');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');

        let uploadedFiles = [];

        // File upload handling
        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
            fileInput.value = '';
        });

        function handleFiles(files) {
            const pdfFiles = Array.from(files).filter(file => file.type === 'application/pdf');

            if (pdfFiles.length === 0) {
                showStatus('Please select PDF files only', 'error');
                return;
            }

            uploadedFiles = [...uploadedFiles, ...pdfFiles];
            updateFileList();
            showStatus(`Added ${pdfFiles.length} PDF file(s)`, 'success');
        }

        function updateFileList() {
            fileList.innerHTML = '';

            uploadedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <span class="file-name">${file.name}</span>
                    <span class="file-size">${formatFileSize(file.size)}</span>
                    <button class="remove-btn" data-index="${index}">&times;</button>
                `;
                fileList.appendChild(fileItem);
            });

            // Add remove button listeners
            document.querySelectorAll('.remove-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const index = parseInt(btn.dataset.index);
                    uploadedFiles.splice(index, 1);
                    updateFileList();
                });
            });

            okBtn.disabled = uploadedFiles.length === 0;
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function showStatus(message, type = 'info') {
            status.textContent = message;
            status.className = `status ${type}`;
        }

        function updateProgress(percent) {
            progressBar.classList.add('active');
            progressFill.style.width = `${percent}%`;
        }

        function clearProgress() {
            progressBar.classList.remove('active');
            progressFill.style.width = '0%';
        }

        // Calculate grid layout for N pages
        function calculateGridLayout(n) {
            // Find the best rectangular grid that fits n pages
            let bestRows, bestCols;
            let minWaste = Infinity;

            for (let cols = 1; cols <= Math.ceil(Math.sqrt(n)); cols++) {
                let rows = Math.ceil(n / cols);
                let waste = rows * cols - n;
                if (waste < minWaste) {
                    minWaste = waste;
                    bestRows = rows;
                    bestCols = cols;
                }
            }

            return { rows: bestRows, cols: bestCols };
        }

        // Load a PDF file as an ArrayBuffer
        async function loadPDF(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // Process PDFs with N-up tiling
        okBtn.addEventListener('click', async () => {
            if (uploadedFiles.length === 0) {
                showStatus('Please upload at least one PDF file', 'error');
                return;
            }

            const pagesPerSheet = parseInt(pageCountInput.value);
            if (pagesPerSheet < 1 || pagesPerSheet > 16) {
                showStatus('Pages per sheet must be between 1 and 16', 'error');
                return;
            }

            okBtn.disabled = true;
            showStatus('Processing PDFs...', 'info');
            updateProgress(5);

            try {
                // Create a new PDF document
                const mergedPdf = await PDFDocument.create();

                // Fixed 2-column layout - calculate rows based on pages per sheet
                const cols = 2;
                const rows = Math.ceil(pagesPerSheet / cols);

                updateProgress(10);

                // Collect all pages from all uploaded files
                let allPages = [];
                for (let i = 0; i < uploadedFiles.length; i++) {
                    showStatus(`Loading PDF ${i + 1} of ${uploadedFiles.length}...`, 'info');
                    const pdfBytes = await loadPDF(uploadedFiles[i]);
                    const pdfDoc = await PDFDocument.load(pdfBytes);
                    const pageCount = pdfDoc.getPageCount();

                    for (let j = 0; j < pageCount; j++) {
                        allPages.push({ pdfDoc, pageIndex: j });
                    }

                    updateProgress(10 + (i + 1) * 40 / uploadedFiles.length);
                }

                if (allPages.length === 0) {
                    showStatus('No pages found in the uploaded PDFs', 'error');
                    okBtn.disabled = false;
                    clearProgress();
                    return;
                }

                updateProgress(50);

                // Process pages in batches
                const totalPages = allPages.length;
                for (let batch = 0; batch < totalPages; batch += pagesPerSheet) {
                    const batchPages = allPages.slice(batch, batch + pagesPerSheet);

                    // Embed pages from the original documents
                    const embeddedPages = [];
                    const pageSizes = [];

                    for (const { pdfDoc, pageIndex } of batchPages) {
                        try {
                            // First copy the page to get its dimensions
                            const [copiedPage] = await mergedPdf.copyPages(pdfDoc, [pageIndex]);
                            const size = copiedPage.getSize();

                            if (size.width > 0 && size.height > 0) {
                                const embeddedPage = await mergedPdf.embedPage(copiedPage);
                                if (embeddedPage) {
                                    embeddedPages.push(embeddedPage);
                                    pageSizes.push(size);
                                }
                            }
                        } catch (error) {
                            console.warn('Failed to embed page:', error);
                        }
                    }

                    if (embeddedPages.length === 0) continue;

                    // Get the size of the first page as reference
                    const { width, height } = pageSizes[0];

                    // Create a new page with the same dimensions
                    const newPage = mergedPdf.addPage([width, height]);

                    // Zero margins for seamless tiling
                    const margin = 0;
                    const cellWidth = width / cols;
                    const cellHeight = height / rows;

                    // Place each page in its grid cell with aspect ratio preservation
                    embeddedPages.forEach((embeddedPage, idx) => {
                        if (idx < pageSizes.length) {
                            const { width: pageWidth, height: pageHeight } = pageSizes[idx];
                            const row = Math.floor(idx / cols);
                            const col = idx % cols;

                            // Calculate scale factor to fit page within cell while maintaining aspect ratio
                            const scaleX = cellWidth / pageWidth;
                            const scaleY = cellHeight / pageHeight;
                            const scale = Math.min(scaleX, scaleY);

                            const scaledWidth = pageWidth * scale;
                            const scaledHeight = pageHeight * scale;

                            // Center the page within the cell
                            const xPos = col * cellWidth + (cellWidth - scaledWidth) / 2;
                            const yPos = height - (row + 1) * cellHeight + (cellHeight - scaledHeight) / 2;

                            // Draw the embedded page onto the new page
                            newPage.drawPage(embeddedPage, {
                                x: xPos,
                                y: yPos,
                                width: scaledWidth,
                                height: scaledHeight
                            });
                        }
                    });

                    updateProgress(50 + (batch + pagesPerSheet) * 40 / totalPages);
                }

                updateProgress(90);

                // Save and download
                const pdfBytes = await mergedPdf.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = `merged-nup-${pagesPerSheet}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                updateProgress(100);
                showStatus('PDF merged and downloaded successfully!', 'success');

                setTimeout(() => {
                    clearProgress();
                }, 2000);

            } catch (error) {
                console.error('Error processing PDFs:', error);
                showStatus('Error processing PDFs: ' + error.message, 'error');
                clearProgress();
            }

            okBtn.disabled = false;
        });
    </script>
</body>
</html>
